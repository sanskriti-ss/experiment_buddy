{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.org/schemas/experiment_plan_microscopy_v0.schema.json",
  "title": "ExperimentPlanMicroscopyV0",
  "type": "object",
  "additionalProperties": false,
  "required": ["schema_version", "study", "design", "samples", "acquisition", "outputs"],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "microscopy_v0"
    },
    "study": {
      "$ref": "#/$defs/study"
    },
    "design": {
      "$ref": "#/$defs/design"
    },
    "samples": {
      "$ref": "#/$defs/samples"
    },
    "acquisition": {
      "$ref": "#/$defs/acquisition"
    },
    "processing_plan": {
      "$ref": "#/$defs/processingPlan"
    },
    "outputs": {
      "$ref": "#/$defs/outputs"
    },
    "notes": {
      "type": "string",
      "description": "Free-form notes. Not used for validation-heavy lints; keep structured info in the fields above."
    }
  },
  "$defs": {
    "study": {
      "type": "object",
      "additionalProperties": false,
      "required": ["title", "objective", "assay_type"],
      "properties": {
        "title": { "type": "string", "minLength": 3 },
        "objective": { "type": "string", "minLength": 10 },
        "assay_type": {
          "type": "string",
          "enum": [
            "fluorescence_microscopy",
            "confocal_microscopy",
            "spinning_disk_confocal",
            "widefield_fluorescence",
            "light_sheet_microscopy",
            "other"
          ]
        },
        "primary_outcomes": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1
        },
        "success_criteria": {
          "type": "string",
          "description": "Human-readable acceptance criteria."
        }
      }
    },

    "design": {
      "type": "object",
      "additionalProperties": false,
      "required": ["conditions", "replicates"],
      "properties": {
        "conditions": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/condition" }
        },
        "replicates": { "$ref": "#/$defs/replicates" },
        "randomization": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "run_order_randomized": { "type": "boolean" },
            "blocking_variables": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Variables you intend to block on (example: plate_id, imaging_day, operator)."
            }
          }
        },
        "batch_variables_to_record": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "date",
              "operator",
              "instrument_id",
              "objective",
              "filter_set",
              "laser_lines",
              "detector",
              "plate_id",
              "well_id",
              "reagent_lot",
              "incubator_settings",
              "exposure_time",
              "laser_power_or_intensity",
              "gain_or_em"
            ]
          },
          "uniqueItems": true
        },
        "controls": {
          "type": "array",
          "items": { "$ref": "#/$defs/control" },
          "description": "Planned controls. Keep them explicit for linting."
        }
      }
    },

    "condition": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "name"],
      "properties": {
        "id": { "type": "string", "pattern": "^[A-Za-z0-9_\\-]+$" },
        "name": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "expected_direction": {
          "type": "string",
          "enum": ["increase", "decrease", "no_change", "unknown"]
        }
      }
    },

    "replicates": {
      "type": "object",
      "additionalProperties": false,
      "required": ["biological_n"],
      "properties": {
        "biological_n": { "type": "integer", "minimum": 1 },
        "technical_n_per_bio": { "type": "integer", "minimum": 1, "default": 1 },
        "notes": { "type": "string" }
      }
    },

    "control": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "applies_to"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "unstained",
            "no_fluorophore",
            "single_color",
            "blank_well",
            "autofluorescence_control",
            "positive_control",
            "negative_control",
            "vehicle_control",
            "beads_multicolor",
            "flat_field_reference",
            "dark_noise_reference",
            "other"
          ]
        },
        "description": { "type": "string" },
        "applies_to": {
          "type": "string",
          "enum": ["each_condition", "each_batch", "once_per_session", "other"]
        },
        "channels": {
          "type": "array",
          "items": { "type": "string" },
          "description": "For single-color controls or bead controls, specify which channels."
        }
      }
    },

    "samples": {
      "type": "object",
      "additionalProperties": false,
      "required": ["sample_type", "preparation", "fluorophores"],
      "properties": {
        "sample_type": {
          "type": "string",
          "description": "Example: fluorescing heart organoids"
        },
        "organism_or_cell_source": { "type": "string" },
        "live_or_fixed": {
          "type": "string",
          "enum": ["live", "fixed", "both"]
        },
        "preparation": {
          "type": "object",
          "additionalProperties": false,
          "required": ["mounting"],
          "properties": {
            "mounting": { "type": "string" },
            "fixation": { "type": "string" },
            "clearing": { "type": "string" },
            "staining": { "type": "string" },
            "timepoints": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Example: day7, day14"
            }
          }
        },
        "fluorophores": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/fluorophore" }
        },
        "plate_layout": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "plate_id": { "type": "string" },
            "plate_format": {
              "type": "string",
              "enum": ["6_well", "12_well", "24_well", "48_well", "96_well", "384_well", "other"]
            },
            "well_ids": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Example: A1, A2, B1..."
            }
          }
        }
      }
    },

    "fluorophore": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "target": { "type": "string", "description": "What it labels (example: nuclei, calcium indicator)." },
        "excitation_nm": { "type": "number", "minimum": 200, "maximum": 900 },
        "emission_nm": { "type": "number", "minimum": 200, "maximum": 1100 }
      }
    },

    "acquisition": {
      "type": "object",
      "additionalProperties": false,
      "required": ["microscope", "channels"],
      "properties": {
        "microscope": { "$ref": "#/$defs/microscope" },
        "channels": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/channel" }
        },
        "z_stack": { "$ref": "#/$defs/zStack" },
        "time_lapse": { "$ref": "#/$defs/timeLapse" },
        "environment": { "$ref": "#/$defs/environment" },
        "run_plan": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "session_count": { "type": "integer", "minimum": 1 },
            "estimated_images_per_session": { "type": "integer", "minimum": 1 },
            "run_order_strategy": {
              "type": "string",
              "enum": ["randomized", "blocked", "by_plate", "by_condition", "other"]
            }
          }
        },
        "qc_plan": { "$ref": "#/$defs/qcPlan" }
      }
    },

    "microscope": {
      "type": "object",
      "additionalProperties": false,
      "required": ["modality", "instrument_id", "objective"],
      "properties": {
        "modality": {
          "type": "string",
          "enum": ["widefield", "confocal", "spinning_disk", "light_sheet", "other"]
        },
        "instrument_id": { "type": "string" },
        "manufacturer": { "type": "string" },
        "model": { "type": "string" },
        "objective": { "$ref": "#/$defs/objective" },
        "detector": { "$ref": "#/$defs/detector" }
      }
    },

    "objective": {
      "type": "object",
      "additionalProperties": false,
      "required": ["magnification_x", "numerical_aperture"],
      "properties": {
        "magnification_x": { "type": "number", "minimum": 1 },
        "numerical_aperture": { "type": "number", "minimum": 0.05, "maximum": 1.7 },
        "immersion": { "type": "string", "enum": ["air", "water", "oil", "glycerol", "other"] }
      }
    },

    "detector": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "type": "string", "enum": ["sCMOS", "CCD", "PMT", "GaAsP", "hybrid", "other"] },
        "binning": { "type": "integer", "minimum": 1 },
        "gain": { "type": "number", "minimum": 0 },
        "offset": { "type": "number" }
      }
    },

    "channel": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "excitation_nm", "emission_nm", "exposure_ms"],
      "properties": {
        "name": { "type": "string" },
        "excitation_nm": { "type": "number", "minimum": 200, "maximum": 900 },
        "emission_nm": { "type": "number", "minimum": 200, "maximum": 1100 },
        "filter_set": { "type": "string" },
        "laser_power_percent": { "type": "number", "minimum": 0, "maximum": 100 },
        "exposure_ms": { "type": "number", "minimum": 0.01 },
        "illumination_intensity": { "type": "number", "minimum": 0 },
        "notes": { "type": "string" }
      }
    },

    "zStack": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": { "type": "boolean" },
        "z_step_um": { "type": "number", "exclusiveMinimum": 0 },
        "z_start_um": { "type": "number" },
        "z_end_um": { "type": "number" },
        "total_slices": { "type": "integer", "minimum": 1 }
      },
      "allOf": [
        {
          "if": { "properties": { "enabled": { "const": true } }, "required": ["enabled"] },
          "then": { "required": ["z_step_um"] }
        }
      ]
    },

    "timeLapse": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": { "type": "boolean" },
        "interval_s": { "type": "number", "exclusiveMinimum": 0 },
        "duration_s": { "type": "number", "exclusiveMinimum": 0 },
        "frames": { "type": "integer", "minimum": 2 }
      },
      "allOf": [
        {
          "if": { "properties": { "enabled": { "const": true } }, "required": ["enabled"] },
          "then": { "required": ["interval_s"] }
        }
      ]
    },

    "environment": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "temperature_c": { "type": "number", "minimum": 0, "maximum": 45 },
        "co2_percent": { "type": "number", "minimum": 0, "maximum": 20 },
        "humidity_percent": { "type": "number", "minimum": 0, "maximum": 100 },
        "notes": { "type": "string" }
      }
    },

    "qcPlan": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "check_saturation": { "type": "boolean" },
        "multicolor_beads": { "type": "boolean" },
        "flat_field_correction_reference": { "type": "boolean" },
        "dark_noise_reference": { "type": "boolean" },
        "notes": { "type": "string" }
      }
    },

    "processingPlan": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "steps": {
          "type": "array",
          "items": { "$ref": "#/$defs/processingStep" }
        },
        "software": {
          "type": "array",
          "items": { "$ref": "#/$defs/softwareRef" }
        }
      }
    },

    "processingStep": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "enum": [
            "flat_field_correction",
            "deconvolution",
            "denoising",
            "registration",
            "segmentation",
            "tracking",
            "intensity_quantification",
            "morphology_quantification",
            "other"
          ]
        },
        "parameters": { "type": "object" },
        "notes": { "type": "string" }
      }
    },

    "softwareRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name"],
      "properties": {
        "name": { "type": "string" },
        "version": { "type": "string" },
        "url": { "type": "string", "format": "uri" }
      }
    },

    "outputs": {
      "type": "object",
      "additionalProperties": false,
      "required": ["raw_data", "naming"],
      "properties": {
        "raw_data": {
          "type": "object",
          "additionalProperties": false,
          "required": ["format", "storage_location"],
          "properties": {
            "format": {
              "type": "string",
              "enum": ["ome_tiff", "tiff", "czi", "lif", "nd2", "dv", "other"]
            },
            "storage_location": { "type": "string" },
            "expected_size_gb": { "type": "number", "minimum": 0 }
          }
        },
        "derived_data": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["type"],
            "properties": {
              "type": {
                "type": "string",
                "enum": ["segmentation_masks", "tracks", "summary_table", "plots", "other"]
              },
              "storage_location": { "type": "string" }
            }
          }
        },
        "naming": {
          "type": "object",
          "additionalProperties": false,
          "required": ["pattern"],
          "properties": {
            "pattern": {
              "type": "string",
              "description": "Example: {date}_{condition}_{plate}_{well}_{organoid_id}_{channel}_{z}_{t}.ome.tif"
            },
            "required_tokens": {
              "type": "array",
              "items": { "type": "string" },
              "default": ["date", "condition", "instrument_id", "plate_id", "well_id"]
            }
          }
        }
      }
    }
  }
}
